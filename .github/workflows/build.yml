name: Build Windows EXE

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install wheel
        pip install PyQt6 pyinstaller requests

    - name: Download ADB for Windows
      run: |
        # 下载并解压 Windows 版 ADB
        Invoke-WebRequest -Uri "https://dl.google.com/android/repository/platform-tools-latest-windows.zip" -OutFile "platform-tools.zip"
        Expand-Archive platform-tools.zip -DestinationPath .
        
        # 调试：列出当前目录结构，方便排查
        Write-Host "Listing current directory:"
        Get-ChildItem
        Write-Host "Listing platform-tools directory:"
        Get-ChildItem platform-tools

        # 移动 adb.exe 到当前目录 (修正路径)
        # 谷歌的压缩包解压后直接就是 platform-tools 文件夹
        Copy-Item platform-tools\adb.exe .
        Copy-Item platform-tools\AdbWinApi.dll .
        Copy-Item platform-tools\AdbWinUsbApi.dll .

    - name: Build with PyInstaller
      run: |
        # 确保 adb.exe 存在
        if (-not (Test-Path "adb.exe")) {
          Write-Error "adb.exe not found in current directory!"
          exit 1
        }
        
        # 打包命令
        pyinstaller --noconfirm --onefile --windowed --add-binary "adb.exe;." --add-binary "AdbWinApi.dll;." --add-binary "AdbWinUsbApi.dll;." --name "NetTestTool_Win" main.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NetTestTool_Windows_EXE
        path: dist/NetTestTool_Win.exe

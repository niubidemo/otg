name: Build Windows EXE

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6 pyinstaller requests

    - name: Download ADB for Windows
      run: |
        # 下载并解压 Windows 版 ADB
        Invoke-WebRequest -Uri "https://dl.google.com/android/repository/platform-tools-latest-windows.zip" -OutFile "platform-tools.zip"
        Expand-Archive platform-tools.zip -DestinationPath .
        # 移动 adb.exe 到当前目录
        Copy-Item platform-tools\platform-tools\adb.exe .
        Copy-Item platform-tools\platform-tools\AdbWinApi.dll .
        Copy-Item platform-tools\platform-tools\AdbWinUsbApi.dll .

    - name: Build with PyInstaller
      run: |
        # 注意：Windows下分隔符是分号 ;
        # 我们打包 adb.exe 以及两个必要的 DLL 文件
        pyinstaller --noconfirm --onefile --windowed --add-binary "adb.exe;." --add-binary "AdbWinApi.dll;." --add-binary "AdbWinUsbApi.dll;." --name "NetTestTool_Win" main.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: NetTestTool_Windows_EXE
        path: dist/NetTestTool_Win.exe
